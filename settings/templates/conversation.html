{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-3" style="max-width:600px;">
  <div class="d-flex align-items-center mb-3">
    <a href="{% url 'inbox' %}" class="btn btn-light me-2"><i class="bi bi-arrow-left"></i></a>
    <h5 class="fw-bold mb-0 text-uppercase">{{ sender }}</h5>
  </div>

  <div id="chatBox" class="card border-0 shadow-sm mb-3 p-3" style="height:60vh; overflow-y:auto;">
    {% for msg in messages %}
      <div class="mb-3 {% if msg.sent_by_user %}text-end{% endif %}">
        <div class="p-2 rounded {% if msg.sent_by_user %}bg-primary text-white{% else %}bg-light{% endif %}">
          {{ msg.body }}
        </div>
        <small class="text-muted">{{ msg.timestamp|date:"H:i, j M" }}</small>
        <button class="btn btn-sm btn-link text-danger p-0 ms-2 delete-btn" data-id="{{ msg.id }}">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    {% endfor %}
  </div>

  <!-- Reply Box -->
  <div class="input-group shadow-sm">
    <input type="text" id="replyInput" class="form-control" placeholder="Type a reply...">
    <button class="btn btn-primary" id="sendReply"><i class="bi bi-send"></i></button>
  </div>
</div>

<script>
  // Delete Message
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const confirmDelete = confirm('Delete this message?');
      if (!confirmDelete) return;

      const res = await fetch("{% url 'delete_message' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      if (data.status === "success") location.reload();
      else alert(data.message);
    });
  });

  // Send Reply
  document.getElementById('sendReply').addEventListener('click', async () => {
    const msg = document.getElementById('replyInput').value.trim();
    if (!msg) return;

    const res = await fetch("{% url 'send_reply' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        sender: "{{ sender }}",
        message: msg
      })
    });

    const data = await res.json();
    if (data.status === "success") location.reload();
    else alert(data.message);
  });
</script>

<style>
  .card {
    border-radius: 1rem;
  }
  .btn-primary {
    background-color: #5a30d0;
    border: none;
  }
  .btn-primary:hover {
    background-color: #4825a8;
  }
</style>

{% endblock %}
