{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- Bootstrap CSS fix -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" crossorigin="anonymous">



<!-- Change SIM Modal -->
<div class="modal fade" id="changeSimModal" tabindex="-1" aria-labelledby="changeSimModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="changeSimModalLabel">Change SIM</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Would you like to change your User ID and select a SIM?</p>
        <p class="text-muted">
          <strong>Device ID:</strong>
          <span id="deviceIdDisplay">{{ request.user.userprofile.device_id|default:"***" }}</span>
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="proceedChangeSim">Change User ID</button>
      </div>
    </div>
  </div>
</div>

<!-- Select SIM Modal -->
<div class="modal fade" id="selectSimModal" tabindex="-1" aria-labelledby="selectSimModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="selectSimModalLabel">Select SIM</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Please select which SIM to use for setting the User ID.</p>
        <div class="mb-3">
          <label for="simType" class="form-label">Select SIM</label>
          <select id="simType" class="form-select">
            <option value="">-- Choose SIM --</option>
            <option value="SIM 1">SIM 1</option>
            <option value="SIM 2">SIM 2</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="simNumber" class="form-label">Enter SIM Number</label>
          <input type="text" id="simNumber" class="form-control" placeholder="07xxxxxxxx">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="confirmSimBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast for Success/Error Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055;">
  <div id="toastMsg" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastText">Action successful!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- JavaScript Logic -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const userIdCard = document.getElementById("userIdCard");
    const changeSimModalEl = document.getElementById("changeSimModal");
    const selectSimModalEl = document.getElementById("selectSimModal");
    const toastMsgEl = document.getElementById("toastMsg");
    const proceedChangeSimBtn = document.getElementById("proceedChangeSim");
    const confirmSimBtn = document.getElementById("confirmSimBtn");

    // Only initialize Bootstrap modals if elements exist
    const changeSimModal = changeSimModalEl ? new bootstrap.Modal(changeSimModalEl) : null;
    const selectSimModal = selectSimModalEl ? new bootstrap.Modal(selectSimModalEl) : null;
    const toastMsg = toastMsgEl ? new bootstrap.Toast(toastMsgEl) : null;

    if (userIdCard && changeSimModal) {
      userIdCard.addEventListener("click", () => changeSimModal.show());
    }

    if (proceedChangeSimBtn && changeSimModal && selectSimModal) {
      proceedChangeSimBtn.addEventListener("click", () => {
        changeSimModal.hide();
        setTimeout(() => selectSimModal.show(), 400);
      });
    }

    if (confirmSimBtn && selectSimModal && toastMsg) {
      confirmSimBtn.addEventListener("click", async () => {
        const simType = document.getElementById("simType").value;
        const simNumber = document.getElementById("simNumber").value.trim();
        const toastText = document.getElementById("toastText");
        const userIdDisplay = document.getElementById("userIdDisplay");
        const deviceIdDisplay = document.getElementById("deviceIdDisplay");

        // Validate inputs
        if (!simType || !simNumber) {
          toastText.innerText = "Please fill all fields.";
          toastMsgEl.classList.replace("text-bg-success","text-bg-danger");
          toastMsg.show();
          return;
        }

        // AJAX request to backend
        try {
          const res = await fetch("{% url 'change_user_id' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ sim_number: simNumber, sim_type: simType }),
          });

          const data = await res.json();

          if (data.status === "success") {
            userIdDisplay.textContent = simNumber;
            deviceIdDisplay.textContent = data.device_id;
            toastText.innerText = data.message;
            toastMsgEl.classList.replace("text-bg-danger","text-bg-success");
          } else {
            toastText.innerText = data.message;
            toastMsgEl.classList.replace("text-bg-success","text-bg-danger");
          }

          selectSimModal.hide();
          toastMsg.show();
        } catch (error) {
          toastText.innerText = "An error occurred. Please try again.";
          toastMsgEl.classList.replace("text-bg-success","text-bg-danger");
          toastMsg.show();
        }
      });
    }
  });
</script>

{% endblock %}