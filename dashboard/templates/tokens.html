{% extends 'base.html' %}
{% load static %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Token Cards -->
  <div class="d-flex flex-column gap-3">
    {% for token in tokens %}
      <div class="card shadow-sm border-0 p-3 d-flex flex-row align-items-center justify-content-between">
        <div>
          <h6 class="fw-bold mb-1">{{ token.name }}</h6>
          <p class="mb-0 text-muted">Ksh. {{ token.price }}</p>
        </div>
        <button class="btn btn-primary px-4 fw-semibold topup-btn"
                data-token="{{ token.name }}"
                data-price="{{ token.price }}">
          Topup
        </button>
      </div>
    {% empty %}
      <div class="alert alert-info text-center">No tokens available.</div>
    {% endfor %}
  </div>
</div>

<!-- Topup Modal -->
<div class="modal fade" id="topupModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded-4">
      <div class="modal-header text-center border-0">
        <h5 class="modal-title w-100 fw-bold text-muted">CART</h5>
      </div>
      <div class="modal-body">
        <p><strong>PRODUCT:</strong> <span id="modalProduct" class="text-muted"></span></p>
        <p><strong>PRICE:</strong> <span id="modalPrice" class="text-muted"></span></p>
        <p><strong>ID:</strong> {{ request.user.userprofile.sim_number|default:"****" }}</p>

        <hr>

        <p class="text-muted mb-2">Select mode of payment:</p>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="mpesaOption" value="mpesa" checked>
          <label class="form-check-label" for="mpesaOption">M-Pesa</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="airtimeOption" value="airtime">
          <label class="form-check-label" for="airtimeOption">Airtime</label>
        </div>

        <div class="mt-3">
          <label class="form-label text-muted">Enter the number used to purchase tokens:</label>
          <input type="text" id="payNumber" maxlength="10" class="form-control" placeholder="07xxxxxxxx">
          <small class="text-muted d-block text-end"><span id="charCount">0</span>/10</small>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-primary w-100 fw-bold" id="checkoutBtn">CHECK OUT</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded-4 p-3">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">Confirmation</h5>
      </div>
      <div class="modal-body" id="confirmText"></div>
      <div class="modal-footer border-0 d-flex justify-content-end">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="proceedPurchase">Proceed</button>
      </div>
    </div>
  </div>
</div>

<script>
  const topupModal = new bootstrap.Modal(document.getElementById("topupModal"));
  const confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"));

  document.querySelectorAll(".topup-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.getElementById("modalProduct").textContent = btn.dataset.token;
      document.getElementById("modalPrice").textContent = `Ksh. ${btn.dataset.price}`;
      topupModal.show();
    });
  });

  document.getElementById("payNumber").addEventListener("input", e => {
    document.getElementById("charCount").textContent = e.target.value.length;
  });

  document.getElementById("checkoutBtn").addEventListener("click", () => {
    const product = document.getElementById("modalProduct").textContent;
    const price = document.getElementById("modalPrice").textContent.replace("Ksh. ", "");
    const number = document.getElementById("payNumber").value.trim();

    if (!number) {
      alert("Please enter your paying number.");
      return;
    }

    // Only Safaricom numbers (start with 07)
    if (!number.startsWith("07")) {
      alert("Only Safaricom lines are supported for token purchases.");
      return;
    }

    const confirmationText = `
      <p>Are you sure you want to purchase <strong>${product}</strong> using <strong>${number}</strong>? 
      The total cost will be <strong>Ksh. ${price}</strong>. An STK push will be sent to the provided number.</p>
      <p class="text-danger fw-semibold small">DO NOT EXIT THE PAGE BEFORE GETTING MPESA CONFIRMATION MESSAGE</p>
    `;
    document.getElementById("confirmText").innerHTML = confirmationText;

    topupModal.hide();
    setTimeout(() => confirmModal.show(), 400);
  });

  document.getElementById("proceedPurchase").addEventListener("click", async () => {
    confirmModal.hide();

    const product = document.getElementById("modalProduct").textContent;
    const price = document.getElementById("modalPrice").textContent.replace("Ksh. ", "");
    const number = document.getElementById("payNumber").value.trim();

    try {
      const res = await fetch("{% url 'process_token_purchase' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ product, price, number }),
      });

      const data = await res.json();
      alert(data.message);

    } catch (error) {
      alert("Error processing request. Please try again.");
    }
  });
</script>

<style>
  .btn-primary {
    background-color: #5a30d0;
    border: none;
  }
  .btn-primary:hover {
    background-color: #4825a8;
    transform: scale(1.05);
    transition: all 0.2s ease;
  }
  .form-check-input:checked {
    background-color: #5a30d0;
    border-color: #5a30d0;
  }
  .modal-content {
    border-radius: 1rem;
  }
</style>

{% endblock %}
